"""
Run a focused Random Forest tuning (RandomizedSearchCV n_iter=30, cv=3) and save tuned model.
Usage: python ProposedApproach/scripts/run_rf_tuning.py
"""
import os
import joblib
import logging
import numpy as np
from sklearn.ensemble import RandomForestClassifier
from sklearn.model_selection import RandomizedSearchCV
from MachineLearningModule.DataAcquisition.ReadDatasetFromCSV import get_dataset_from_csv_file
from MachineLearningModule.MachineLearningFlow import data_pre_processing
import mlflow

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

DATASET_PATH = os.path.join('ProposedApproach','Datasets','Drebin_v1.csv')


def run_tuning(n_iter=30, cv=3):
    dataset, class_name = get_dataset_from_csv_file(DATASET_PATH)
    x, y = data_pre_processing(dataset, class_name)

    param_dist = {
        'n_estimators': list(range(100, 1001, 100)),
        'max_depth': [None, 10, 20, 50],
        'min_samples_leaf': [1, 2, 5],
        'max_features': ['sqrt', 'log2']
    }

    rf = RandomForestClassifier(random_state=42, n_jobs=-1)
    rnd = RandomizedSearchCV(rf, param_distributions=param_dist, n_iter=n_iter, cv=cv, n_jobs=-1, random_state=42)
    logger.info('Starting RandomizedSearchCV: n_iter=%d cv=%d', n_iter, cv)
    rnd.fit(x, y)
    logger.info('Tuning completed. Best params: %s', rnd.best_params_)

    os.makedirs(os.path.join('ProposedApproach','models'), exist_ok=True)
    out_path = os.path.join('ProposedApproach','models','rf_tuned.pkl')
    joblib.dump(rnd.best_estimator_, out_path)
    logger.info('Saved tuned RF model to %s', out_path)

    # log to local mlflow
    try:
        mlflow.set_tracking_uri('file:./ProposedApproach/mlruns')
        with mlflow.start_run(run_name='RF_Tuning'):
            mlflow.log_params(rnd.best_params_)
            mlflow.log_metric('best_score', rnd.best_score_)
            mlflow.sklearn.log_model(rnd.best_estimator_, 'rf_tuned')
    except Exception as e:
        logger.warning('MLflow logging failed: %s', e)

    return rnd


if __name__ == '__main__':
    run_tuning(30, 3)
